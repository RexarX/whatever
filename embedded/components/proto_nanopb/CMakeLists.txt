# ESP-IDF component for nanopb with proto generation
# Uses nanopb from git submodule in embedded/third_party/nanopb
# This is much simpler than downloading during build

# Configuration
# Get the project root directory (where proto/ is located)
# CMAKE_CURRENT_LIST_DIR is the location of this CMakeLists.txt file
# components/proto_nanopb/CMakeLists.txt -> go up 3 levels to reach project root
get_filename_component(PROJECT_ROOT "${CMAKE_CURRENT_LIST_DIR}/../../.." ABSOLUTE)
set(NANOPB_DIR "${PROJECT_ROOT}/embedded/third_party/nanopb")
set(PROTO_DIR "${PROJECT_ROOT}/proto")

# Proto files
set(PROTO_FILE "${PROTO_DIR}/messages.proto")
set(PROTO_OPTIONS "${PROTO_DIR}/messages.options")

# Generated files
set(GENERATED_DIR "${CMAKE_CURRENT_BINARY_DIR}/generated")
set(PROTO_SRCS "${GENERATED_DIR}/messages.pb.c")
set(PROTO_HDRS "${GENERATED_DIR}/messages.pb.h")

# Create directories
file(MAKE_DIRECTORY "${GENERATED_DIR}")

# Verify nanopb submodule is initialized
if(NOT EXISTS "${NANOPB_DIR}/pb.h")
    message(FATAL_ERROR
        "Nanopb submodule not found!\n"
        "Please run: git submodule update --init --recursive\n"
        "Expected location: ${NANOPB_DIR}")
endif()

# Create placeholder files for initial configuration
if(NOT EXISTS "${PROTO_SRCS}")
    file(WRITE "${PROTO_SRCS}" "/* Generated by nanopb */\n")
endif()
if(NOT EXISTS "${PROTO_HDRS}")
    file(WRITE "${PROTO_HDRS}" "/* Generated by nanopb */\n#pragma once\n")
endif()

# Register ESP-IDF component
idf_component_register(
    SRCS
        "${NANOPB_DIR}/pb_common.c"
        "${NANOPB_DIR}/pb_encode.c"
        "${NANOPB_DIR}/pb_decode.c"
        "${PROTO_SRCS}"
    INCLUDE_DIRS
        "${NANOPB_DIR}"
        "${GENERATED_DIR}"
)

# Configure nanopb
target_compile_definitions(${COMPONENT_LIB} PUBLIC
    PB_FIELD_32BIT=1      # 32-bit field tags
    PB_NO_ERRMSG=0        # Include error messages
    PB_BUFFER_ONLY=1      # Buffer-only mode
)

set_target_properties(${COMPONENT_LIB} PROPERTIES
    C_STANDARD 11
    C_STANDARD_REQUIRED ON
)

# Find Python for proto generation
find_package(Python3 COMPONENTS Interpreter REQUIRED)

# Generate proto files
set(NANOPB_GENERATOR "${NANOPB_DIR}/generator/nanopb_generator.py")

if(EXISTS "${PROTO_FILE}")
    if(EXISTS "${PROTO_OPTIONS}")
        set(OPTIONS_ARG "-f" "${PROTO_OPTIONS}")
    else()
        set(OPTIONS_ARG "")
    endif()

    add_custom_command(
        OUTPUT "${PROTO_SRCS}" "${PROTO_HDRS}"
        COMMAND ${Python3_EXECUTABLE} "${NANOPB_GENERATOR}"
            -I "${PROTO_DIR}"
            -D "${GENERATED_DIR}"
            ${OPTIONS_ARG}
            "${PROTO_FILE}"
        DEPENDS "${PROTO_FILE}" "${PROTO_OPTIONS}"
        COMMENT "Generating nanopb sources from messages.proto"
        VERBATIM
    )

    add_custom_target(proto_generate ALL DEPENDS "${PROTO_SRCS}" "${PROTO_HDRS}")
    add_dependencies(${COMPONENT_LIB} proto_generate)

    message(STATUS "Proto nanopb component configured")
    message(STATUS "  Nanopb: ${NANOPB_DIR}")
    message(STATUS "  Protos: ${PROTO_DIR}")
else()
    message(FATAL_ERROR "Proto file not found: ${PROTO_FILE}")
endif()
